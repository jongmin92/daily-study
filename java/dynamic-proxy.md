# 다이나믹 프록시

https://github.com/jongmin92/code-examples/tree/master/java/dynamic-proxy

가장 일반적인 형태인 경우, **`프록시(Proxy)`는 어떤 다른 것에 대한 인터페이스로서의 기능을 한다.** 프록시는 모든 것에 대한 인터페이스가 될 수 있다. 예를 들어 네트워크 연결, 메모리상에 적재된 거대한 객체, 파일과 같은 것들이 그 대상이 될 수 있다.

프록시 패턴은 프록시를 이용하여 원래 객체의 변경 없이 객체의 기능을 특정 방식으로 제어하는 '구조'를 의미한다. 프록시 패턴을 사용하면 다음과 같은 기능을 수행할 수 있다.
- 목표 기능 수행 전/후에 추가적인 기능 수행
- 목표 기능 수행 과정에서 발생한 예외에 대한 처리/조작
- 특별한 조건에 부합되는 경우 목표 기능 수행 방지
- 목표 기능 수행 시점 변경

위의 예시 외에도 다양한 처리가 가능하다.

![uml](/java/image/dynamic-proxy/uml.jpg)

프록시 패턴을 사용하기 위해 프록시 클래스를 직접 작성하고 대상 클래스의 기능을 직접 호출하는 프록시 방식을 정적 프록시라고 한다. 정적 프록시는 단순하고 이해하기 쉬워 손쉽게 구현할 수 있다는 장점이 있지만, 프록시 클래스를 직접 작성해야 하고 Subject
의 기능이 추가/수정될 때마다 프록시의 구현도 추가/수정되어야 한다는 단점이 있다.

Java 1.3 버전부터 이런 단점을 보완한 [다이나믹 프록시](https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html
)를 제공한다. **`다이나믹 프록시`는 `런타임`에 지정된 인터페이스들을 구현하는 클래스 혹은 인터페이스를 생성하는 기술이다.** 리플랙션(Reflection) 패키지를 통해 제공된다.

- `Proxy.newProxyInstance` 메소드를 이용해 프록시 객체를 생성한다.
    - 첫번째 인자는 프록시 객체를 생성할 인터페이스 타입의 클래스로더
    - 두번째 인자는 해당 프록시가 구현해야하는 인터페이스
    - 세번째 인자는 이를 구현하는 InvocationHandler 이다.
- `InvocationHandler`는 invoke 메소드를 구현한다.
    - 첫번째 인자는 newProxyInstance를 사용해 생성된 프록시 객체의 참조
    - 두번째 인자는 프록시를 통해 호출된 메소드의 참조
    - 세번째 인자는 해당 메소드의 파라메터들의 참조

대표적인 사용 예로 Spring AOP가 있으며, Spring Data JPA는 Spring AOP를 사용하고 있다. (Spring AOP의 ProxyFactory는 프록시를 추상화해서 사용하고 있다.)

**자바가 기본적으로 제공하는 프록시는 인터페이스에 대해서만 생성이 가능하다. 클래스에 대해서는 프록시를 생성할 수 없다.**

# CGlib
클래스에 대해서 프록시를 생성하고 싶다면 [CGlib](https://github.com/cglib/cglib) 라이브러리를 사용해 생성할 수 있다. Spring과 Hibernate에서 사용하고 있다.





